<!DOCTYPE html>
<html>
<head>
<title>Graph</title>
<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; minimum-scale=1.0; user-scalable=0;" />
<style>
* {
  margin: 0;
  padding: 0;
  font-family: Verdana, arial, sans-serif;
}

#yaxis {
  float: left;
  position: fixed;
  top: 0;
  left: 0;
}

#message {
  padding: 1em;
  text-align: center;
}

header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  text-align: center;
}

header h1 {
  display: inline-block;
  margin: 0 auto;
  border-bottom-left-radius: 1em;
  border-bottom-right-radius: 1em;
  background-color: rgba(255,255,255,0.75);
  -webkit-box-shadow: 0 0 4px rgba(0,0,0,0.5);
  box-shadow: 0 0 4px rgba(0,0,0,0.5);
  padding: 0 1em;
}

header h1 {
  font-size: 1em;
  font-weight: normal;
}
#graphtype {
  font-style: italic;
}

</style>

<script src="http://maps.googleapis.com/maps/api/js?sensor=false"></script> 
<script src="weatherParser.js"></script>
<script src="graph.js"></script>
<script>

var g = null;
var data = null;

/*
data = [
{ day: "2011-07-13", hour:  7, temp: 70, apparent: 72, dew: 59 },
{ day: "2011-07-13", hour:  8, temp: 70, apparent: 71, dew: 57 },
{ day: "2011-07-13", hour:  9, temp: 71, apparent: 72, dew: 59 },
{ day: "2011-07-13", hour: 10, temp: 72, apparent: 78, dew: 60 },
{ day: "2011-07-13", hour: 11, temp: 77, apparent: 81, dew: 61 },
{ day: "2011-07-13", hour: 12, temp: 79, apparent: 88, dew: 59 },
{ day: "2011-07-13", hour: 13, temp: 82, apparent: 89, dew: 62 },
{ day: "2011-07-13", hour: 14, temp: 80, apparent: 90, dew: 62 },
{ day: "2011-07-13", hour: 15, temp: 81, apparent: 91, dew: 63 },
{ day: "2011-07-13", hour: 16, temp: 83, apparent: 92, dew: 65 },
{ day: "2011-07-13", hour: 17, temp: 81, apparent: 89, dew: 65 },
{ day: "2011-07-13", hour: 18, temp: 79, apparent: 88, dew: 68 },
{ day: "2011-07-13", hour: 19, temp: 78, apparent: 85, dew: 69 },
{ day: "2011-07-13", hour: 20, temp: 76, apparent: 81, dew: 71 },
{ day: "2011-07-13", hour: 21, temp: 72, apparent: 80, dew: 70 },
{ day: "2011-07-13", hour: 22, temp: 70, apparent: 72, dew: 59 },
{ day: "2011-07-13", hour: 23, temp: 70, apparent: 71, dew: 57 },
{ day: "2011-07-14", hour:  0, temp: 71, apparent: 72, dew: 59 },
{ day: "2011-07-14", hour:  1, temp: 72, apparent: 78, dew: 60 },
{ day: "2011-07-14", hour:  2, temp: 77, apparent: 81, dew: 61 },
{ day: "2011-07-14", hour:  3, temp: 79, apparent: 88, dew: 59 },
{ day: "2011-07-14", hour:  4, temp: 82, apparent: 89, dew: 62 },
{ day: "2011-07-14", hour:  5, temp: 80, apparent: 90, dew: 62 },
{ day: "2011-07-14", hour:  6, temp: 81, apparent: 91, dew: 63 },
{ day: "2011-07-14", hour:  7, temp: 83, apparent: 92, dew: 65 },
{ day: "2011-07-14", hour:  8, temp: 81, apparent: 89, dew: 65 },
{ day: "2011-07-14", hour:  9, temp: 79, apparent: 88, dew: 68 },
{ day: "2011-07-14", hour: 10, temp: 78, apparent: 85, dew: 69 },
{ day: "2011-07-14", hour: 11, temp: 76, apparent: 81, dew: 71 },
{ day: "2011-07-14", hour: 12, temp: 72, apparent: 80, dew: 70 },
];
*/

function redraw() {
  if (!data) return;
  //g.getGraphCanvas().width = data.length * 40;
  g.getGraphCanvas().height = Math.min(window.innerHeight - 5, 200);
  g.getYAxisCanvas().width = 30;
  g.getYAxisCanvas().height = Math.min(window.innerHeight - 5, 200);
  g.setGridWidth(30);
  g.setMaximumGridHeight(30);
  g.setMaximumVerticalSpace(300);

  if (data.length > 0) {
    var minY = 1000;
    var maxY = -200;
    for (var i = 0; data[i]; i++) {
      var temp = data[i].temp;
      var apparent = data[i].apparent;
      var dew = data[i].dew;

      var max = Math.max(temp, apparent, dew);
      var min = Math.min(temp, apparent, dew);
      var logMax = Math.ceil((max + 0.5) / 10) * 10;
      var logMin = Math.floor((min - 0.5) / 10) * 10;
      minY = Math.min(minY, logMin);
      maxY = Math.max(maxY, logMax);
    }

    g.setLogicalYBounds(minY, maxY);
  }

  g.redraw(data);
  document.getElementById('graphtype').innerText = 'Temperature';
  document.getElementById('loaded').style.display = 'block';
}



function onload() {
  var graphCanvas = document.getElementById("graph");
  var yAxisCanvas = document.getElementById("yaxis");
  g = new SecondGriffin.WeatherGraph(graph, yaxis);
  window.addEventListener("resize", redraw, false);

  setMessage("Retrieving location.");

  if (navigator.geolocation && navigator.geolocation.getCurrentPosition) {
    navigator.geolocation.getCurrentPosition(
      function (success) { loadData(success.coords); loadLocationName(success.coords); },
      function (failure) { setMessage("Failed to retrieve location."); }
    );
  }
}

function loadLocationName(position) {
  // Until we actually have a name of a place, just put in the Lat/Long.
  document.getElementById("location").innerText = (Math.round(position.latitude * 100) / 100).toString() + ", " + (Math.round(position.longitude * 100) / 100).toString();

  var geocoder = new google.maps.Geocoder();
  var location = new google.maps.LatLng(position.latitude, position.longitude);
  geocoder.geocode({ "location": location }, function (results, status) {
    if (status == google.maps.GeocoderStatus.OK) {
      var found = false;
      var location;
      for (var i = 0; results[i]; i++) {
        if (found) break;

        var result = results[i];
	console.log(result);

        for (var j = 0; result.types[j]; j++) {
	  if (found) break;

	  if (result.types[j] == "political") {
	    location = result.formatted_address;
	    found = true;
	  }
	}
      }

      if (!found) {
        location = result[0].formatted_address;
      }

      // If our string ends with ", USA", we want to remove it.
      if (location.lastIndexOf(", USA") + 5 == location.length) {
        location = location.substring(0, s.lastIndexOf(", USA"));
      }

      document.getElementById("location").innerText = location;
    }
  });
}

function loadData(position) {
  setMessage("Loading weather data.");
  var url = "http://forecast.weather.gov/MapClick.php?w0=t&w1=td&w2=hi&w3u=1&AheadHour=0&FcstType=digital&textField1=" + position.latitude + "&textField2=" + position.longitude;
  var xhr = new XMLHttpRequest();  
  xhr.onreadystatechange = function() {
    if (xhr.readyState == 4) {
      if (xhr.status == 200) {
        data = new SecondGriffin.WeatherParser().parse(xhr.responseText);
        setMessage(null);
        redraw();
      }
      else {
        setMessage("Failed to get weather data.");
      }
    }
    console.log(xhr);
  };
  xhr.open("GET", url, true);
  xhr.send(null);
}

function setMessage(text) {
  var message = document.getElementById("message");
  if (!message) return;
  
  if (!!text) {
    message.innerText = text;
    message.style.display = "block";
  }
  else {
    message.innerText = "";
    message.style.display = "none";
  }
}


</script>
</head>
<body onload="onload()">
<div id="loaded" style="display: none;">
  <canvas id="yaxis" width="0" height="0"></canvas>
  <canvas id="graph" width="0" height="0"></canvas>
  <header>
    <h1><span id="location"></span> &ndash; <span id="graphtype"></span></h1>
  </header>
</div>
<div id="loading">
  <div id="message">Loading.</div>
</div>
</body>
</html>
