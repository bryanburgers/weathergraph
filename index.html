<!DOCTYPE html>
<html>
<head>
<title>Graph</title>
<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; minimum-scale=1.0; user-scalable=0;" />
<style>
* {
  margin: 0;
  padding: 0;
  font-family: Verdana, arial, sans-serif;
}

#yaxis {
  position: fixed;
  top: 0;
  left: 0;
}

#key {
  position: fixed;
  right: 0;
  bottom: 0;
}

#message {
  padding: 1em;
  text-align: center;
}


header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  text-align: center;
}

header h1 {
  display: inline-block;
  margin: 0 auto;
  border-bottom-left-radius: 1em;
  border-bottom-right-radius: 1em;
  background-color: rgba(255,255,255,0.75);
  -webkit-box-shadow: 0 2px 4px rgba(0,0,0,0.5);
  box-shadow: 0 2px 4px rgba(0,0,0,0.5);
  padding: 0 1em;
}

header h1 {
  font-size: 1em;
  font-weight: normal;
}
#graphtype {
  font-style: italic;
}

.selection {
  position: fixed;
  bottom: 0;
  padding: 1em 0.75em;
}
.selection a {
  margin: 0 0.25em;
  text-decoration: none;
  color: black;
}
.selection a:hover {
  text-decoration: underline;
}


#menu {
  position: fixed;
  top: 10;
  bottom: 10;
  left: 5;
  right: 5;
  -webkit-box-shadow: 0 2px 8px rgba(0,0,0,0.75);
  box-shadow: 0 2px 8px rgba(0,0,0,0.75);
  border-radius: 1em;
  background-color: rgb(240,240,240);
}
#menu ul {
  list-style-type: none;
  background-color: white;
  margin: 1em 0;
  border-bottom: 1px solid rgb(200, 200, 200);
}
#menu li {
  border-top: 1px solid rgb(200, 200, 200);
}
#menu ul a {
  display: block;
  padding: 0.5em;
  color: black;
  text-decoration: none;
}
#menu a strong {
  display: block;
}
#menu a span {
  display: block;
  font-size: 0.8em;
}

</style>

<script src="phonegap.js"></script>
<script src="http://maps.googleapis.com/maps/api/js?sensor=false"></script> 
<script src="weatherParser.js"></script>
<script src="graph.js"></script>
<script>

var g = null;
var data = [];
var mode = SecondGriffin.WeatherGraph.TEMPERATURE;
var position = null;
var hoursAhead = 0;

/*
data = [
{ day: "2011-07-13", hour:  7, temp: 70, apparent: 72, dew: 59, wind: 3, windDirection: "N", gust: null },
{ day: "2011-07-13", hour:  8, temp: 70, apparent: 71, dew: 57, wind: 4, windDirection: "NNE", gust: null },
{ day: "2011-07-13", hour:  9, temp: 71, apparent: 72, dew: 59, wind: 5, windDirection: "NE", gust: 22 },
{ day: "2011-07-13", hour: 10, temp: 72, apparent: 78, dew: 60, wind: 7, windDirection: "ENE", gust: 23 },
{ day: "2011-07-13", hour: 11, temp: 77, apparent: 81, dew: 61, wind: 9, windDirection: "E", gust: 28 },
{ day: "2011-07-13", hour: 12, temp: 79, apparent: 88, dew: 59, wind: 10, windDirection: "ESE", gust: null },
{ day: "2011-07-13", hour: 13, temp: 82, apparent: 89, dew: 62, wind: 11, windDirection: "SE", gust: null },
{ day: "2011-07-13", hour: 14, temp: 80, apparent: 90, dew: 62, wind: 14, windDirection: "SSE", gust: null },
{ day: "2011-07-13", hour: 15, temp: 81, apparent: 91, dew: 63, wind: 15, windDirection: "S", gust: null },
{ day: "2011-07-13", hour: 16, temp: 83, apparent: 92, dew: 65, wind: 16, windDirection: "SSW", gust: null },
{ day: "2011-07-13", hour: 17, temp: 81, apparent: 89, dew: 65, wind: 17, windDirection: "SW", gust: null },
{ day: "2011-07-13", hour: 18, temp: 79, apparent: 88, dew: 68, wind: 19, windDirection: "WSW", gust: 22 },
{ day: "2011-07-13", hour: 19, temp: 78, apparent: 85, dew: 69, wind: 20, windDirection: "W", gust: 28 },
{ day: "2011-07-13", hour: 20, temp: 76, apparent: 76, dew: 71, wind: 21, windDirection: "WNW", gust: null },
{ day: "2011-07-13", hour: 21, temp: 72, apparent: 72, dew: 70, wind: 24, windDirection: "NW", gust: null },
{ day: "2011-07-13", hour: 22, temp: 70, apparent: 70, dew: 51, wind: 25, windDirection: "NNW", gust: null },
{ day: "2011-07-13", hour: 23, temp: 70, apparent: 70, dew: 57, wind: 26, windDirection: "N", gust: 21 },
{ day: "2011-07-14", hour:  0, temp: 71, apparent: 71, dew: 59, wind: 29, windDirection: "N", gust: null },
{ day: "2011-07-14", hour:  1, temp: 72, apparent: 72, dew: 60, wind: 30, windDirection: "N", gust: null },
{ day: "2011-07-14", hour:  2, temp: 77, apparent: 77, dew: 61, wind: 31, windDirection: "N", gust: null },
{ day: "2011-07-14", hour:  3, temp: 79, apparent: 88, dew: 59, wind: 10, windDirection: "N", gust: null },
{ day: "2011-07-14", hour:  4, temp: 82, apparent: 89, dew: 62, wind: 10, windDirection: "N", gust: null },
{ day: "2011-07-14", hour:  5, temp: 80, apparent: 90, dew: 62, wind: 10, windDirection: "N", gust: null },
{ day: "2011-07-14", hour:  6, temp: 81, apparent: 91, dew: 63, wind: 10, windDirection: "N", gust: null },
{ day: "2011-07-14", hour:  7, temp: 83, apparent: 92, dew: 65, wind: 10, windDirection: "N", gust: null },
{ day: "2011-07-14", hour:  8, temp: 81, apparent: 89, dew: 65, wind: 10, windDirection: "N", gust: null },
{ day: "2011-07-14", hour:  9, temp: 79, apparent: 88, dew: 68, wind: 10, windDirection: "N", gust: null },
{ day: "2011-07-14", hour: 10, temp: 78, apparent: 85, dew: 69, wind: 10, windDirection: "N", gust: null },
{ day: "2011-07-14", hour: 11, temp: 76, apparent: 81, dew: 71, wind: 10, windDirection: "N", gust: null },
{ day: "2011-07-14", hour: 12, temp: 72, apparent: 80, dew: 70, wind: 10, windDirection: "N", gust: null },
];
*/

function redraw() {
  if (!data || data.length == 0) return;
  g.getYAxisCanvas().width = 30;
  g.setGridWidth(30);
  g.setMaximumGridHeight(30);
  g.setMaximumVerticalSpace(300);

  g.redraw(data, mode);
  var graphtype = document.getElementById('graphtype');
  switch (mode) {
    case SecondGriffin.WeatherGraph.TEMPERATURE:
      graphtype.innerText = 'Temperature';
      break;
    case SecondGriffin.WeatherGraph.WIND:
      graphtype.innerText = 'Wind';
      break;
  }
  document.getElementById('loaded').style.display = 'block';
}


function onload() {
  var graphCanvas = document.getElementById("graph");
  var yAxisCanvas = document.getElementById("yaxis");
  var keyCanvas = document.getElementById("key");
  g = new SecondGriffin.WeatherGraph(graphCanvas, yAxisCanvas, keyCanvas);
  window.addEventListener("resize", redraw, false);

  var tempSelect = document.getElementById("temperatureSelect");
  var windSelect = document.getElementById("windSelect");
  tempSelect.addEventListener("click", selectTemperature, false);
  windSelect.addEventListener("click", selectWind, false);
  tempSelect.addEventListener("touchstart", selectTemperatureTouch, false);
  windSelect.addEventListener("touchstart", selectWindTouch, false);

  setMessage("Retrieving location.");

  if (navigator.geolocation && navigator.geolocation.getCurrentPosition) {
    navigator.geolocation.getCurrentPosition(
      function (success) {
        data = []; // Clear old data
        position = success.coords; // Set the current position
	hoursAhead = 0; // Set the hours ahead to load
        loadData(); // Load the data
        loadLocationName(position); // Find the name of the location
      },
      function (failure) { setMessage("Failed to retrieve location."); }
    );
  }
  
  // Event handler for when PhoneGap is ready
  document.addEventListener('deviceready', onDeviceReady, false);

}

function initializeMenuOption(el, menu) {
  el.addEventListener('touchstart', function(e) {
    menu.style.display = 'none';
    document.removeEventListener('backbutton', onBackButton, false);
    mode = parseInt(el.getAttribute('data-mode'));
    redraw();
  }, false);
}

function onDeviceReady(e) {
  // Event handler for the menu button
  document.addEventListener('menubutton', onMenuButton, false);
}

function onMenuButton(e) {
  var menu = document.getElementById('menu');
  if (menu.style.display == 'block')
  {
    menu.style.display = 'none';
    document.removeEventListener('backbutton', onBackButton, false);
  }
  else
  {
    menu.style.display = 'block';
    document.addEventListener('backbutton', onBackButton, false);

    var buttons = menu.getElementsByTagName("a");
    for (var i = 0; i < buttons.length; i++) {
      initializeMenuOption(buttons[i], menu);
    }
  }
}

function onBackButton(e) {
  // If the menu is showing, hide it. Otherwise, ignore this button.
  var menu = document.getElementById('menu');
  if (menu.style.display == 'block')
  {
    menu.style.display = 'none';
    document.removeEventListener('backbutton', onBackButton, false);
    e.preventDefault();
  }
}

function loadLocationName(position) {
  // Until we actually have a name of a place, just put in the Lat/Long.
  document.getElementById("location").innerText = (Math.round(position.latitude * 100) / 100).toString() + ", " + (Math.round(position.longitude * 100) / 100).toString();

  var geocoder = new google.maps.Geocoder();
  var location = new google.maps.LatLng(position.latitude, position.longitude);
  geocoder.geocode({ "location": location }, function (results, status) {
    if (status == google.maps.GeocoderStatus.OK) {
      var found = false;
      var location;
      for (var i = 0; results[i]; i++) {
        if (found) break;

        var result = results[i];
        console.log(result);

        for (var j = 0; result.types[j]; j++) {
          if (found) break;

          if (result.types[j] == "political") {
            location = result.formatted_address;
            found = true;
          }
        }
      }

      if (!found) {
        location = result[0].formatted_address;
      }

      // If our string ends with ", USA", we want to remove it.
      //if (location.lastIndexOf(", USA") + 5 == location.length) {
      //  location = location.substring(0, s.lastIndexOf(", USA"));
      //}
      //location.replace(", USA", "");

      document.getElementById("location").innerText = location;
    }
  });
}

function loadData() {
  setMessage("Loading weather data.");
  var url = "http://forecast.weather.gov/MapClick.php?w0=t&w1=td&w2=hi&w3=sfcwind&w3u=1&AheadHour=" + hoursAhead + "&FcstType=digital&textField1=" + position.latitude + "&textField2=" + position.longitude;
  var xhr = new XMLHttpRequest();  
  xhr.onreadystatechange = function() {
    if (xhr.readyState == 4) {
      if (xhr.status == 200) {
        var newData = new SecondGriffin.WeatherParser().parse(xhr.responseText);
        data = data.concat(newData);
	hoursAhead += newData.length;
        setMessage(null);
        redraw();
	// Allow for loading more data when we scroll far enough.
        window.addEventListener("scroll", scroll, false);
      }
      else {
        setMessage("Failed to get weather data.");
      }
    }
    console.log(xhr);
  };
  xhr.open("GET", url, true);
  xhr.send(null);
}

function setMessage(text) {
  var message = document.getElementById("message");
  if (!message) return;
  
  if (!!text) {
    message.innerText = text;
    message.style.display = "block";
  }
  else {
    message.innerText = "";
    message.style.display = "none";
  }
}

function selectTemperatureTouch(e) {
  document.getElementById("temperatureSelect").removeEventListener("click", selectTemperature, false);
  selectTemperature(e);
}

function selectTemperature(e) {
  mode = SecondGriffin.WeatherGraph.TEMPERATURE;
  redraw();
  e.preventDefault();
}

function selectWindTouch(e) {
  document.getElementById("windSelect").removeEventListener("click", selectWind, false);
  selectWind(e);
}

function selectWind(e) {
  mode = SecondGriffin.WeatherGraph.WIND;
  redraw();
  e.preventDefault();
}

function scroll(e) {
  var rightEdge = window.pageXOffset + window.innerWidth;
  if (rightEdge > document.getElementById("graph").width - 40) {
    window.removeEventListener("scroll", scroll, false);
    if (position != null && hoursAhead <= 96) { // Weather.gov accepts a query for 96, but nothing after that.
      loadData();
    }
  }
}

</script>
</head>
<body onload="onload()">
<div id="loaded" style="display: none;">
  <canvas id="yaxis" width="0" height="0"></canvas>
  <canvas id="graph" width="0" height="0"></canvas>
  <canvas id="key" width="150" height="50"></canvas>
  <header>
    <h1><span id="location"></span> &ndash; <span id="graphtype"></span></h1>
  </header>
  <div class="selection">
    <a href="#" id="temperatureSelect">Temperature</a> |
    <a href="#" id="windSelect">Wind</a>
  </div>
</div>
<div id="loading">
  <div id="message">Loading.</div>
</div>
<div id="menu" style="display: none;">
  <ul>
    <li>
      <a href="#" id="menuTemperatureSelect" data-command="mode" data-mode="1">
        <strong>Temperature</strong>
        <span>Temperature, heat index, and dew point</span>
      </a>
    </li>
    <li>
      <a href="#" id="menuWindSelect" data-command="mode" data-mode="2">
        <strong>Wind</strong>
        <span>Wind speed, wind direction, and gusts</span>
      </a>
    </li>
  </ul>
</div>
</body>
</html>
